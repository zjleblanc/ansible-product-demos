---
- name: Get packages
  ansible.builtin.package_facts:
  check_mode: false

- name: Get services
  ansible.builtin.service_facts:
  check_mode: false

- name: Pre-check | services state
  delegate_to: localhost
  ansible.builtin.copy:
    content: "{{ services | to_json }}"
    dest: "{{ pre_check_path }}"

- name: Upgrade packages (yum)
  ansible.builtin.yum:
    name: '*'
    state: latest # noqa: package-latest - Intended to update packages to latest
    exclude: "{{ exclude_packages }}"
  when: ansible_pkg_mgr == "yum"
  register: patchingresult_yum

- name: Upgrade packages (dnf)
  ansible.builtin.dnf:
    name: '*'
    state: latest # noqa: package-latest - Intended to update packages to latest
    exclude: "{{ exclude_packages }}"
  when: ansible_pkg_mgr == "dnf"
  register: patchingresult_dnf

- name: Check to see if we need a reboot
  ansible.builtin.command: needs-restarting -r
  register: result
  changed_when: result.rc == 1
  failed_when: result.rc > 1
  check_mode: false

- name: Reboot Server if Necessary
  ansible.builtin.reboot:
  when:
    - result.rc == 1
    - allow_reboot

- name: Get services
  ansible.builtin.service_facts:
  check_mode: false

- name: Post-check | services state
  register: r_post_check
  ansible.utils.fact_diff:
    before: "{{ lookup('file', pre_check_path) | from_json }}"
    after: "{{ services }}"

- name: Save diff for report
  ansible.builtin.set_fact:
    post_check_diff: "{{ r_post_check.diff_text }}"